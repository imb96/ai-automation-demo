name: Auto PR from AI Issue

on:
  issues:
    types: [opened, labeled]

jobs:
  create-pr-from-issue:
    # ai-generated ë¼ë²¨ì´ ìˆëŠ” Issueë§Œ ì²˜ë¦¬
    if: contains(github.event.issue.labels.*.name, 'ai-generated')
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Extract code from issue
        id: extract
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const body = issue.body;
            
            // ì½”ë“œ ë¸”ë¡ ì¶”ì¶œ
            const codeMatch = body.match(/```typescript\n([\s\S]*?)\n```/);
            const code = codeMatch ? codeMatch[1] : null;
            
            // Metadata ì¶”ì¶œ
            const metadataMatch = body.match(/```json\n([\s\S]*?)\n```/);
            const metadata = metadataMatch ? JSON.parse(metadataMatch[1]) : {};
            
            if (!code || !metadata.filename) {
              core.setFailed('Could not extract code or filename from issue');
              return;
            }
            
            // ë¸Œëœì¹˜ ì´ë¦„ ìƒì„±
            const branchName = `ai-issue-${issue.number}`;
            
            core.setOutput('code', code);
            core.setOutput('filename', metadata.filename);
            core.setOutput('branch', branchName);
            core.setOutput('notionPageId', metadata.notionPageId || '');
            
      - name: Create branch and commit file
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CODE: ${{ steps.extract.outputs.code }}
          FILENAME: ${{ steps.extract.outputs.filename }}
          BRANCH: ${{ steps.extract.outputs.branch }}
        run: |
          # Git ì„¤ì •
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # ìƒˆ ë¸Œëœì¹˜ ìƒì„±
          git checkout -b $BRANCH
          
          # ë””ë ‰í† ë¦¬ ìƒì„± (í•„ìš”ì‹œ)
          mkdir -p $(dirname "$FILENAME")
          
          # íŒŒì¼ ìƒì„±
          echo "$CODE" > "$FILENAME"
          
          # ì»¤ë°‹
          git add "$FILENAME"
          git commit -m "feat: Add $FILENAME

Auto-generated from Issue #${{ github.event.issue.number }}"
          
          # Push
          git push origin $BRANCH
          
      - name: Create Pull Request
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const branch = '${{ steps.extract.outputs.branch }}';
            
            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ¤– ${issue.title.replace('[AUTO] ', '')}`,
              head: branch,
              base: 'main',
              body: `## ğŸ¤– AI Generated PR

This PR was automatically created from Issue #${issue.number}

### ğŸ“ Changes
- Added \`${{ steps.extract.outputs.filename }}\`

### ğŸ” Review Checklist
- [ ] Code follows project standards
- [ ] TypeScript types are correct
- [ ] No security issues

### ğŸ”— Related
- Closes #${issue.number}
- Notion Page: ${{ steps.extract.outputs.notionPageId }}

---
*Auto-generated by GitHub Actions*`
            });
            
            // Issueì— ì½”ë©˜íŠ¸ ì¶”ê°€
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: `âœ… Pull Request created: #${pr.data.number}

ğŸ”— [View PR](${pr.data.html_url})`
            });
            
            // Issue ë‹«ê¸°
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              state: 'closed',
              labels: ['ai-generated', 'auto-pr', 'completed']
            });